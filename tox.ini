# NOTICE: there is a packaging bug in Ubuntu 18.04: https://bugs.launchpad.net/ubuntu/+source/apt-btrfs-snapshot/+bug/1763923 (fixed)

[tox]
envlist = {py27,py36,py37}

# Since pip is not able to propagate the CMAKE_TOOLCHAIN_FILE value to scikit build
# we skip building from source package. TODO: figure out the cooperaton between pip
# and scikit-build
skipsdist=true

[testenv]
passenv = 
    VCPKG_ROOT
    PORT_A
    PORT_B

deps = 
    scikit-build
    ninja
    cmake
    flake8

commands =
    # Remove the command below when pip or scikit build is able to use the CMAKE_TOOLCHAIN_FILE option
    {envpython} setup.py bdist_wheel -- -DCMAKE_TOOLCHAIN_FILE={env:VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake
    {envpython} -m pip install --force-reinstall --only-binary pc-ble-driver-py --find-links dist pc-ble-driver-py
    {envpython} tests/test_driver_open_close.py --port-a {env:PORT_A} --port-b {env:PORT_B} --log-level debug --driver-log-level trace
